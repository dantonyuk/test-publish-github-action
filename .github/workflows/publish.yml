name: Publish Test

on:
  push:
    branches:
      - master
  issue_comment:
    types:
      - created

  workflow_dispatch:
    inputs:
      version:
        description: Version (leave empty to get it from the sources)
        required: false
        default: ""

jobs:
  info:
    runs-on: ubuntu-latest
    steps:
      - name: Info
        run: |
          echo ACTION: ${{ github.event_name }}
  publish:
    if: |
      (github.event.issue.pull_request && (
        startsWith(github.event.comment.body, '/snapshot') ||
        startsWith(github.event.comment.body, '/release'))) ||
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    # permissions:
    #   id-token: write
    #   contents: write
    #   issues: write
    #   pull-requests: write
    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: |
        env
        echo "$GITHUB_CONTEXT"

    - uses: actions/checkout@v2
      # run: |
      #   [ -n "${{ github.event.issue.id }}" ] && git checkout 

    - name: Determine Version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "issue_comment" ]
        then
          echo "${{ github.event.comment.body }}"
          if [[ "${{ github.event.comment.body }}" =~ ^/(snapshot|release)([[:space:]]+([^[:space:]]*))?$ ]]
          then
            version=${BASH_REMATCH[3]}
            if [ "${BASH_REMATCH[1]}" = "snapshot" ]
            then
              IS_SNAPSHOT=yes
            fi
          else
            exit 100
          fi
        fi

        [ -z "${version}" ] && source gradle.properties
        [ -n "${IS_SNAPSHOT}" ] && version=${version}-SNAPSHOT
        echo "::set-output name=value::${version}"
        echo "VERSION: $version"
      env:
        version: ${{ github.event.inputs.version }}

    - name: Publish
      id: publish
      if: steps.version.outcome == 'success'
      run: |
        echo "Publishing..."

    - name: Tag Release
      if: steps.publish.outcome == 'success'
      run: |
        TAG=v${{ steps.version.outputs.value }}
        git tag ${TAG}
        git push origin ${TAG}

    - uses: actions/github-script@v6
      if: github.event_name == 'issue_comment' && steps.publish.outcome == 'success'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸ‘‹ Version ${{ steps.version.outputs.value }} has been successfully released'
          })
